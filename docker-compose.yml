# Docker Compose configuration for local development
# This setup mimics the Cloud Run environment for local testing

version: '3.8'

services:
  smart-aac-api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Google Cloud Configuration (for local development)
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-your-dev-project-id}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials/service-account-key.json
      
      # Firebase Configuration
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-your-dev-project-id}
      
      # Vertex AI Configuration
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      
      # Cloud Storage Configuration
      - STORAGE_BUCKET_NAME=${STORAGE_BUCKET_NAME:-your-dev-project-id-aac-storage}
      
      # Server Configuration
      - NODE_ENV=development
      - PORT=8080
      - LOG_LEVEL=debug
    volumes:
      # Mount service account key for local development
      - ./credentials:/app/credentials:ro
      # Mount source code for development (optional)
      - ./src:/app/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    
  # Optional: Local Firestore emulator for development
  firestore-emulator:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk:latest
    ports:
      - "8081:8081"
      - "4000:4000"
    command: >
      bash -c "
        gcloud components install cloud-firestore-emulator --quiet &&
        gcloud emulators firestore start --host-port=0.0.0.0:8081
      "
    environment:
      - FIRESTORE_EMULATOR_HOST=localhost:8081
    profiles:
      - emulator

networks:
  default:
    name: smart-aac-network