#!/usr/bin/env node

/**
 * Test Script for Icon Upload Endpoint
 * Tests both manual upload and AI-enhanced upload options
 */

const fs = require('fs');
const path = require('path');
const FormData = require('form-data');
const axios = require('axios');

// Configuration
const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:8080';
const TEST_USER_TOKEN = process.env.TEST_USER_TOKEN;

// Colors for console output
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function logSection(title) {
  console.log('\n' + '='.repeat(60));
  log(title, 'cyan');
  console.log('='.repeat(60) + '\n');
}

async function testIconUpload() {
  logSection('üß™ Testing Icon Upload Endpoint');

  if (!TEST_USER_TOKEN) {
    log('‚ùå Error: TEST_USER_TOKEN environment variable not set', 'red');
    log('Please set TEST_USER_TOKEN with a valid Firebase ID token', 'yellow');
    log('Example: export TEST_USER_TOKEN="your-firebase-token"', 'yellow');
    process.exit(1);
  }

  // Create a simple test image (1x1 PNG)
  const testImageBuffer = Buffer.from(
    'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
    'base64'
  );

  // Test 1: Upload without AI generation
  logSection('Test 1: Upload Icon Without AI Generation');
  
  try {
    const formData1 = new FormData();
    formData1.append('image', testImageBuffer, {
      filename: 'test-icon.png',
      contentType: 'image/png'
    });
    formData1.append('generateIcon', 'false');
    formData1.append('label', 'Test Icon - Manual Upload');
    formData1.append('category', 'test');

    log('üì§ Uploading icon without AI generation...', 'blue');
    
    const response1 = await axios.post(
      `${API_BASE_URL}/api/v1/icons/generate-from-image`,
      formData1,
      {
        headers: {
          ...formData1.getHeaders(),
          'Authorization': `Bearer ${TEST_USER_TOKEN}`
        }
      }
    );

    if (response1.data.success) {
      log('‚úÖ Upload successful!', 'green');
      log(`Icon ID: ${response1.data.data.id}`, 'green');
      log(`Icon Type: ${response1.data.data.iconType}`, 'green');
      log(`Generated by AI: ${response1.data.data.generatedByAI}`, 'green');
      log(`Public URL: ${response1.data.data.publicUrl}`, 'green');
      console.log('\nFull Response:', JSON.stringify(response1.data, null, 2));
    } else {
      log('‚ùå Upload failed', 'red');
      console.log(response1.data);
    }
  } catch (error) {
    log('‚ùå Test 1 Failed:', 'red');
    if (error.response) {
      console.log('Status:', error.response.status);
      console.log('Error:', JSON.stringify(error.response.data, null, 2));
    } else {
      console.log(error.message);
    }
  }

  // Test 2: Upload with AI generation
  logSection('Test 2: Upload Icon With AI Generation');
  
  try {
    const formData2 = new FormData();
    formData2.append('image', testImageBuffer, {
      filename: 'test-icon-ai.png',
      contentType: 'image/png'
    });
    formData2.append('generateIcon', 'true');
    formData2.append('label', 'Test Icon - AI Generated');
    formData2.append('category', 'test');

    log('üì§ Uploading icon with AI generation...', 'blue');
    log('‚ö†Ô∏è  Note: This will use AI services and may take longer', 'yellow');
    
    const response2 = await axios.post(
      `${API_BASE_URL}/api/v1/icons/generate-from-image`,
      formData2,
      {
        headers: {
          ...formData2.getHeaders(),
          'Authorization': `Bearer ${TEST_USER_TOKEN}`
        }
      }
    );

    if (response2.data.success) {
      log('‚úÖ Upload with AI generation successful!', 'green');
      log(`Icon ID: ${response2.data.data.id}`, 'green');
      log(`Icon Type: ${response2.data.data.iconType}`, 'green');
      log(`Generated by AI: ${response2.data.data.generatedByAI}`, 'green');
      log(`Public URL: ${response2.data.data.publicUrl}`, 'green');
      
      if (response2.data.data.analysis) {
        log('\nAI Analysis:', 'cyan');
        log(`Description: ${response2.data.data.analysis.description}`, 'cyan');
        log(`Confidence: ${response2.data.data.analysis.confidence}`, 'cyan');
      }
      
      console.log('\nFull Response:', JSON.stringify(response2.data, null, 2));
    } else {
      log('‚ùå Upload with AI generation failed', 'red');
      console.log(response2.data);
    }
  } catch (error) {
    log('‚ùå Test 2 Failed:', 'red');
    if (error.response) {
      console.log('Status:', error.response.status);
      console.log('Error:', JSON.stringify(error.response.data, null, 2));
    } else {
      console.log(error.message);
    }
  }

  // Test 3: Upload with missing image (should fail)
  logSection('Test 3: Upload Without Image (Expected to Fail)');
  
  try {
    const formData3 = new FormData();
    formData3.append('label', 'Test Icon - No Image');

    log('üì§ Attempting upload without image...', 'blue');
    
    const response3 = await axios.post(
      `${API_BASE_URL}/api/v1/icons/generate-from-image`,
      formData3,
      {
        headers: {
          ...formData3.getHeaders(),
          'Authorization': `Bearer ${TEST_USER_TOKEN}`
        }
      }
    );

    log('‚ùå Test should have failed but succeeded', 'red');
    console.log(response3.data);
  } catch (error) {
    if (error.response && error.response.status === 400) {
      log('‚úÖ Correctly rejected upload without image', 'green');
      log(`Error Code: ${error.response.data.code}`, 'green');
      log(`Error Message: ${error.response.data.error}`, 'green');
    } else {
      log('‚ùå Unexpected error:', 'red');
      console.log(error.response ? error.response.data : error.message);
    }
  }

  logSection('üéâ Icon Upload/Generation Tests Complete');
}

// Run tests
testIconUpload().catch(error => {
  log('\n‚ùå Fatal Error:', 'red');
  console.error(error);
  process.exit(1);
});
